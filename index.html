<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我要做 Bistro 主理人</title>
    <link rel="stylesheet" href="styles/base.css">
    <script src="vendor/html2canvas.min.js"></script>
</head>
<body>

    <div class="top-bar">
        <span>🍳 伪精致 Bistro 生成器</span>
    </div>

    <div class="main-container">
        <header>
            <h1>我要做 <strong>Bistro</strong> 主理人</h1>
            <p class="subtitle">输入你的身份描述，生成专属的伪精致餐厅</p>
            <p class="quote">“在平凡中寻找不平凡，在普通中创造奇迹”</p>
        </header>

        <div class="input-area">
            <textarea id="identity-input" rows="5" placeholder="例如：我是一个热爱咖啡的程序员，周末喜欢看书写代码，梦想开一家小店..."></textarea>
            <div class="textarea-decorator">✨</div>
        </div>

        <button id="generate-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L14.09 8.26L20 10.35L14.09 12.44L12 18.7L9.91 12.44L4 10.35L9.91 8.26L12 2Z" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>
            <span>生成我的 Bistro</span>
        </button>

        <p class="hint">💡 提示：描述越详细，生成的 Bistro 越个性化</p>

        <div id="menu-container" style="display: none;">
            <div id="menu-display">
                <!-- Menu content will be generated here -->
            </div>
            <button id="save-btn">💾 保存为图片</button>
        </div>
        
    </div>

    <footer>
        <p>🍿 由 Cline Agent 开发 | 专业的伪精致餐厅生成器</p>
        <p>"让平凡的生活在反讽中闪闪发光"</p>
    </footer>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const identityInput = document.getElementById('identity-input');
        const menuContainer = document.getElementById('menu-container');
        const menuDisplay = document.getElementById('menu-display');
        const saveBtn = document.getElementById('save-btn');

        generateBtn.addEventListener('click', async () => {
            const identity = identityInput.value.trim();
            if (!identity) {
                alert('请输入你的身份描述！');
                return;
            }

            const btnSpan = generateBtn.querySelector('span');
            btnSpan.textContent = '生成中...';
            generateBtn.disabled = true;

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identity: identity })
                });

                if (!response.ok) {
                    throw new Error(`服务器出错了: ${response.statusText}`);
                }

                const data = await response.json();
                renderMenu(data);
                menuContainer.style.display = 'block';

            } catch (error) {
                console.error('生成失败:', error);
                menuDisplay.innerHTML = `<div class="error"><p>糟糕，灵感枯竭了... 请稍后再试。</p><p class="error-details">${error.message}</p></div>`;
            } finally {
                btnSpan.textContent = '生成我的 Bistro';
                generateBtn.disabled = false;
            }
        });

        function renderMenu(data) {
            let menuHtml = `
                <div class="menu-header">
                    <h2 class="menu-title">${data['店铺名称']}</h2>
                    <p class="menu-slogan-cn">${data['Slogan（中）']}</p>
                    <p class="menu-slogan-en">${data['Slogan (EN)']}</p>
                </div>
                <div class="menu-body">
            `;

            for (const category in data['菜单']) {
                if (Object.hasOwnProperty.call(data['菜单'], category)) {
                    menuHtml += `<h3 class="menu-category-title">${category}</h3>`;
                    const items = data['菜单'][category];
                    items.forEach(item => {
                        menuHtml += `
                            <div class="menu-item">
                                <h4 class="dish-name-cn">${item['菜品（中）']}</h4>
                                <p class="dish-name-en">${item['Dish (EN/FR)']}</p>
                                <p class="dish-desc">${item['身份梗·哲学说明']}</p>
                            </div>
                        `;
                    });
                }
            }
            
            menuHtml += '</div>';
            menuDisplay.innerHTML = menuHtml;
        }

        saveBtn.addEventListener('click', () => {
            // Add class to set fixed width for capture
            menuDisplay.classList.add('menu-for-capture');

            html2canvas(menuDisplay, {
                useCORS: true,
                backgroundColor: '#F8FBF8', // Match the menu background
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'my-bistro-menu.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('保存图片失败:', err);
                alert('无法保存图片，请检查浏览器控制台获取更多信息。');
            }).finally(() => {
                // Always remove the class after capture, even if it fails
                menuDisplay.classList.remove('menu-for-capture');
            });
        });
    </script>
</body>
</html>
