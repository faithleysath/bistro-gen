<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘è¦åš Bistro ä¸»ç†äºº</title>
    <link rel="stylesheet" href="styles/base.css">
    <script src="vendor/html2canvas.min.js"></script>
</head>
<body>

    <div class="top-bar">
        <span>ğŸ³ ä¼ªç²¾è‡´ Bistro ç”Ÿæˆå™¨</span>
    </div>

    <div class="main-container">
        <header>
            <h1>æˆ‘è¦åš <strong>Bistro</strong> ä¸»ç†äºº</h1>
            <p class="subtitle">è¾“å…¥ä½ çš„èº«ä»½æè¿°ï¼Œç”Ÿæˆä¸“å±çš„ä¼ªç²¾è‡´é¤å…</p>
            <p class="quote">â€œåœ¨å¹³å‡¡ä¸­å¯»æ‰¾ä¸å¹³å‡¡ï¼Œåœ¨æ™®é€šä¸­åˆ›é€ å¥‡è¿¹â€</p>
        </header>

        <div class="input-area">
            <textarea id="identity-input" rows="5" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä¸€ä¸ªçƒ­çˆ±å’–å•¡çš„ç¨‹åºå‘˜ï¼Œå‘¨æœ«å–œæ¬¢çœ‹ä¹¦å†™ä»£ç ï¼Œæ¢¦æƒ³å¼€ä¸€å®¶å°åº—..."></textarea>
            <div class="textarea-decorator">âœ¨</div>
        </div>

        <button id="generate-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L14.09 8.26L20 10.35L14.09 12.44L12 18.7L9.91 12.44L4 10.35L9.91 8.26L12 2Z" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>
            <span>ç”Ÿæˆæˆ‘çš„ Bistro</span>
        </button>

        <p class="hint">ğŸ’¡ æç¤ºï¼šæè¿°è¶Šè¯¦ç»†ï¼Œç”Ÿæˆçš„ Bistro è¶Šä¸ªæ€§åŒ–</p>

        <div id="menu-container" style="display: none;">
            <div id="menu-display">
                <!-- Menu content will be generated here -->
            </div>
            <button id="save-btn">ğŸ’¾ ä¿å­˜ä¸ºå›¾ç‰‡</button>
        </div>
        
    </div>

    <footer>
        <p>ğŸ¿ ç”± Cline Agent å¼€å‘ | ä¸“ä¸šçš„ä¼ªç²¾è‡´é¤å…ç”Ÿæˆå™¨</p>
        <p>"è®©å¹³å‡¡çš„ç”Ÿæ´»åœ¨åè®½ä¸­é—ªé—ªå‘å…‰"</p>
    </footer>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const identityInput = document.getElementById('identity-input');
        const menuContainer = document.getElementById('menu-container');
        const menuDisplay = document.getElementById('menu-display');
        const saveBtn = document.getElementById('save-btn');

        generateBtn.addEventListener('click', async () => {
            const identity = identityInput.value.trim();
            if (!identity) {
                alert('è¯·è¾“å…¥ä½ çš„èº«ä»½æè¿°ï¼');
                return;
            }

            const btnSpan = generateBtn.querySelector('span');
            btnSpan.textContent = 'ç”Ÿæˆä¸­...';
            generateBtn.disabled = true;

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identity: identity })
                });

                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨å‡ºé”™äº†: ${response.statusText}`);
                }

                const data = await response.json();
                renderMenu(data);
                menuContainer.style.display = 'block';

            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                menuDisplay.innerHTML = `<div class="error"><p>ç³Ÿç³•ï¼Œçµæ„Ÿæ¯ç«­äº†... è¯·ç¨åå†è¯•ã€‚</p><p class="error-details">${error.message}</p></div>`;
            } finally {
                btnSpan.textContent = 'ç”Ÿæˆæˆ‘çš„ Bistro';
                generateBtn.disabled = false;
            }
        });

        function renderMenu(data) {
            let menuHtml = `
                <div class="menu-header">
                    <h2 class="menu-title">${data['åº—é“ºåç§°']}</h2>
                    <p class="menu-slogan-cn">${data['Sloganï¼ˆä¸­ï¼‰']}</p>
                    <p class="menu-slogan-en">${data['Slogan (EN)']}</p>
                </div>
                <div class="menu-body">
            `;

            for (const category in data['èœå•']) {
                if (Object.hasOwnProperty.call(data['èœå•'], category)) {
                    menuHtml += `<h3 class="menu-category-title">${category}</h3>`;
                    const items = data['èœå•'][category];
                    items.forEach(item => {
                        menuHtml += `
                            <div class="menu-item">
                                <h4 class="dish-name-cn">${item['èœå“ï¼ˆä¸­ï¼‰']}</h4>
                                <p class="dish-name-en">${item['Dish (EN/FR)']}</p>
                                <p class="dish-desc">${item['èº«ä»½æ¢—Â·å“²å­¦è¯´æ˜']}</p>
                            </div>
                        `;
                    });
                }
            }
            
            menuHtml += '</div>';
            menuDisplay.innerHTML = menuHtml;
        }

        saveBtn.addEventListener('click', () => {
            // Add class to set fixed width for capture
            menuDisplay.classList.add('menu-for-capture');

            html2canvas(menuDisplay, {
                useCORS: true,
                backgroundColor: '#F8FBF8', // Match the menu background
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'my-bistro-menu.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('ä¿å­˜å›¾ç‰‡å¤±è´¥:', err);
                alert('æ— æ³•ä¿å­˜å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚');
            }).finally(() => {
                // Always remove the class after capture, even if it fails
                menuDisplay.classList.remove('menu-for-capture');
            });
        });
    </script>
</body>
</html>
